## Internationalization (i18n) & Localization (l10n)

Internationalization (i18n) is the process of making code translatable. Localization (l10n) is providing actual translations for a specific locale.

### Text Domains

A text domain is a unique identifier that ensures WordPress can distinguish translations belonging to different plugins/themes. The text domain must match the plugin or theme slug (the directory name). Text domains should be lowercase, use dashes (not underscores), and contain no spaces.

In plugin/theme headers, declare it:
```php
/*
 * Plugin Name: My Plugin
 * Text Domain: my-plugin
 * Domain Path: /languages
 */
```

### Basic Translation Functions

**`__( $text, $domain )`** — Retrieve translated string, return it.
- `$text` (string) — text to translate
- `$domain` (string) — text domain; default `'default'` (WordPress core)
- Returns: translated string, or original if no translation found

```php
$label = __( 'Settings', 'my-plugin' );
```

**`_e( $text, $domain )`** — Retrieve translated string, echo it directly.
- Same parameters as `__()`; returns void (echoes output)

```php
_e( 'Save Changes', 'my-plugin' );
```

### Escaped Translation Functions

Always use these when outputting into HTML or attributes to prevent XSS:

**`esc_html__( $text, $domain )`** — translate and escape for safe HTML output. Returns string.
**`esc_html_e( $text, $domain )`** — translate, escape, and echo for safe HTML output. Returns void.

```php
echo '<p>' . esc_html__( 'Welcome back!', 'my-plugin' ) . '</p>';
esc_html_e( 'No results found.', 'my-plugin' );
```

**`esc_attr__( $text, $domain )`** — translate and escape for safe use in HTML attributes. Returns string.
**`esc_attr_e( $text, $domain )`** — translate, escape, and echo for HTML attributes. Returns void.

```php
echo '<input placeholder="' . esc_attr__( 'Search...', 'my-plugin' ) . '">';
```

### Pluralization

**`_n( $single, $plural, $number, $domain )`** — select singular or plural form based on count.
- `$single` (string) — singular form
- `$plural` (string) — plural form
- `$number` (int) — the count that determines which form to use
- `$domain` (string) — text domain
- Returns: translated string (singular or plural)

Always use `sprintf()` to insert the number:
```php
printf(
    _n( '%s comment', '%s comments', $count, 'my-plugin' ),
    number_format_i18n( $count )
);
```

**`_nx( $single, $plural, $number, $context, $domain )`** — plural with disambiguation context.

### Context-Aware Translation

When the same English word has different meanings in different contexts:

**`_x( $text, $context, $domain )`** — translate with context. Returns string.
- `$context` (string) — context description for translators

```php
$type = _x( 'Post', 'noun: a blog post', 'my-plugin' );
$action = _x( 'Post', 'verb: to publish', 'my-plugin' );
```

**`_ex( $text, $context, $domain )`** — translate with context and echo. Returns void.

### Loading Translation Files

**For plugins:**
```php
function my_plugin_load_textdomain() {
    load_plugin_textdomain(
        'my-plugin',        // text domain
        false,              // deprecated param
        dirname( plugin_basename( __FILE__ ) ) . '/languages'
    );
}
add_action( 'init', 'my_plugin_load_textdomain' );
```

`load_plugin_textdomain( $domain, $deprecated, $plugin_rel_path )`
- `$domain` (string) — text domain
- `$deprecated` (string|false) — no longer used, pass `false`
- `$plugin_rel_path` (string|false) — relative path from `WP_PLUGIN_DIR` to the languages directory
- Returns: bool (true on success)

Note: Since WordPress 6.7, just-in-time translation loading is used for WordPress.org-hosted plugins; calling this manually is not required for .org plugins.

**For themes:**
```php
function my_theme_load_textdomain() {
    load_theme_textdomain( 'my-theme', get_template_directory() . '/languages' );
}
add_action( 'after_setup_theme', 'my_theme_load_textdomain' );
```

`load_theme_textdomain( $domain, $path )` — loads theme translations.

**Generic:**
`load_textdomain( $domain, $mofile )` — load a specific .mo file for a domain.

### Translation File Formats

- **POT (Portable Object Template)** — master template containing all translatable strings extracted from source code. Generated by tools; not a translation itself.
- **PO (Portable Object)** — human-readable translation file for a specific locale (e.g., `my-plugin-fr_FR.po`). Contains original string and its translation.
- **MO (Machine Object)** — compiled binary version of the PO file that WordPress reads at runtime for performance. Named like `my-plugin-fr_FR.mo`.
- **JSON** — used for JavaScript translations. Named like `my-plugin-fr_FR-{md5hash}.json`. Generated from PO files.

File naming convention: `{text-domain}-{locale}.{ext}` (e.g., `my-plugin-de_DE.mo`)

### WP-CLI Commands

```sh
# Extract translatable strings from source into a POT file
wp i18n make-pot . languages/my-plugin.pot --domain=my-plugin

# Generate JSON translation files from PO (for JavaScript strings)
wp i18n make-json languages/ --no-purge

# Create MO files from PO files
wp i18n make-mo languages/
```

### JavaScript Internationalization

WordPress provides a JS i18n system via the `wp.i18n` package (available as the `wp-i18n` script dependency).

**Register translations for a script:**
```php
function my_plugin_enqueue_scripts() {
    wp_enqueue_script(
        'my-plugin-script',
        plugin_dir_url( __FILE__ ) . 'js/app.js',
        array( 'wp-i18n' ),  // declare wp-i18n dependency
        '1.0.0',
        true
    );
    wp_set_script_translations( 'my-plugin-script', 'my-plugin', plugin_dir_path( __FILE__ ) . 'languages' );
}
add_action( 'wp_enqueue_scripts', 'my_plugin_enqueue_scripts' );
```

`wp_set_script_translations( $handle, $domain, $path )`
- `$handle` (string) — registered script handle
- `$domain` (string) — text domain
- `$path` (string) — absolute path to directory containing JSON translation files
- Must be called after the script is registered/enqueued
- Returns: bool

**JavaScript usage:**
```js
const { __, _n, _x, sprintf } = wp.i18n;

const label = __( 'Settings', 'my-plugin' );

const msg = sprintf(
    _n( '%d item', '%d items', count, 'my-plugin' ),
    count
);

const ctx = _x( 'Post', 'noun', 'my-plugin' );
```

Available JS functions mirror PHP: `__()`, `_n()`, `_x()`, `_nx()`, `sprintf()`.

### Hooks

**`gettext`** — filter every translated string.
```php
add_filter( 'gettext', function( $translation, $text, $domain ) {
    // Modify translation
    return $translation;
}, 10, 3 );
```

**`gettext_{domain}`** — filter translations for a specific text domain only.
```php
add_filter( 'gettext_my-plugin', function( $translation, $text, $domain ) {
    return $translation;
}, 10, 3 );
```

**`ngettext`** — filter plural translations.
**`ngettext_{domain}`** — filter plural translations for a specific domain.

**`gettext_with_context`** — filter context-aware translations.
**`gettext_with_context_{domain}`** — domain-specific version.

**`load_textdomain_mofile`** — filter the MO file path before loading.
**`plugin_locale`** — filter the locale used for plugin translations.

### Best Practices

1. **Never use variable text domains** — the domain must be a string literal so tools can extract strings:
   ```php
   // WRONG:
   __( 'Hello', $domain );
   // CORRECT:
   __( 'Hello', 'my-plugin' );
   ```

2. **Never concatenate translatable strings** — translators need full sentences:
   ```php
   // WRONG:
   __( 'He drove a ', 'my-plugin' ) . $color . __( ' car.', 'my-plugin' );
   // CORRECT:
   sprintf( __( 'He drove a %s car.', 'my-plugin' ), $color );
   ```

3. **Use placeholders with sprintf/printf** — let translators reorder words:
   ```php
   // Good — numbered placeholders for reordering:
   sprintf( __( '%1$s wrote %2$s', 'my-plugin' ), $author, $title );
   ```

4. **Add translator comments** for ambiguous strings:
   ```php
   /* translators: %s: name of the city */
   printf( __( 'Welcome to %s', 'my-plugin' ), $city );
   ```

5. **Escape output** — always use `esc_html__()`, `esc_attr__()`, etc. when outputting to HTML.

6. **Don't translate URLs, code, or HTML tags** — only translate human-readable text.

7. **Keep sentences whole** — do not split sentences across multiple translation calls.

8. **Include number in both singular and plural forms** for `_n()`:
   ```php
   // CORRECT:
   _n( '%s star', '%s stars', $rating, 'my-plugin' );
   ```
